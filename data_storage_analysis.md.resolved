# æ•°æ®å­˜å‚¨å±‚å®Œæ•´åˆ†æ

ç³»ç»Ÿå…±æœ‰ **6 å¼  MySQL è¡¨** + **1 ä¸ªå†…å­˜æ•°æ®ç»“æ„**ã€‚

---

## æ€»è§ˆ

| å­˜å‚¨ | ç³»ç»Ÿå†…è‡ªåŠ¨å†™å…¥ | éœ€å¤–éƒ¨æ’å…¥ | ç³»ç»Ÿå†…è¯»å– |
|------|:-:|:-:|:-:|
| `users` | âŒ | âœ… | âœ… |
| `user_telemetry_log` | âœ… | âŒ | âœ… |
| `user_weekly_patterns` | âŒ | âœ… | âœ… |
| `user_known_places` | âŒ | âœ… | âœ… |
| `intervention_log` | âœ… | âŒ | âŒ |
| `error_log` | âœ…ï¼ˆæœªå®ç°ï¼‰ | âŒ | âŒ |
| å†…å­˜æ»‘åŠ¨çª—å£ `deque` | âœ… | âŒ | âœ… |

---

## è¯¦ç»†åˆ†æ

### 1. `users` â€” ğŸ”´ éœ€å¤–éƒ¨æ’å…¥

| æ“ä½œ | æ¥æº | ä½ç½® | è¯´æ˜ |
|------|------|------|------|
| **INSERT** | âŒ æ— é“¾è·¯å†™å…¥ | â€” | ç³»ç»Ÿä¸ä¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼Œ**å¿…é¡»æ‰‹åŠ¨/å¤–éƒ¨æ’å…¥** |
| **SELECT** | Gateway | [persistence.py#get_user_age](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/gateway/services/persistence.py) | æ¯æ¬¡ `/telemetry` è¯·æ±‚æŸ¥ `birth_year` ç®—å¹´é¾„ |
| UPDATE/DELETE | âŒ æ—  | â€” | â€” |

> [!CAUTION]
> å¦‚æœ `users` è¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„ `user_id`ï¼ŒGateway ä¼šå°†å¹´é¾„é»˜è®¤ä¸º 30 å²ç»§ç»­è¿è¡Œï¼Œä¸ä¼šæŠ¥é”™ã€‚

---

### 2. `user_telemetry_log` â€” âœ… ç³»ç»Ÿè‡ªåŠ¨å†™å…¥

| æ“ä½œ | æ¥æº | ä½ç½® | è¯´æ˜ |
|------|------|------|------|
| **INSERT** | Gateway | [persistence.py#persist_telemetry](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/gateway/services/persistence.py) | æ¯æ¬¡ `/telemetry` è¯·æ±‚è‡ªåŠ¨å†™å…¥ä¸€æ¡ |
| **SELECT** (Gateway) | Gateway | [triage.py#evaluate_hard_triggers](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/gateway/services/triage.py) | ç¡¬è§¦å‘æ£€æŸ¥ï¼š`SELECT count WHERE recorded_at >= æœ€è¿‘30åˆ†é’Ÿ` |
| **SELECT** (MCP) | Patient History MCP | [patient_history_mcp.py](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/mcp_servers/patient_history_mcp.py) | æŸ¥è¿‡å» 24h çš„è¡€ç³–å†å² |
| UPDATE/DELETE | âŒ æ—  | â€” | æ•°æ®åªå¢ä¸æ”¹ |

> [!NOTE]
> è¿™æ˜¯å”¯ä¸€ä¸€å¼ ç”±ç³»ç»Ÿè¯·æ±‚é“¾è·¯**è‡ªåŠ¨å†™å…¥**çš„ä¸šåŠ¡æ•°æ®è¡¨ã€‚æ•°æ®æ¥è‡ª App å‘é€çš„ `/telemetry` è¯·æ±‚ä½“ã€‚

---

### 3. `user_weekly_patterns` â€” ğŸ”´ éœ€å¤–éƒ¨æ’å…¥

| æ“ä½œ | æ¥æº | ä½ç½® | è¯´æ˜ |
|------|------|------|------|
| **INSERT** | âŒ æ— é“¾è·¯å†™å…¥ | â€” | ç³»ç»Ÿä¸ä¼šè‡ªåŠ¨ç”Ÿæˆè¡Œä¸ºæ¨¡å¼ï¼Œ**å¿…é¡»æ‰‹åŠ¨/å¤–éƒ¨æ’å…¥** |
| **SELECT** (Gateway) | Gateway | [triage.py#_check_upcoming_activity](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/gateway/services/triage.py) | è½¯è§¦å‘æ£€æŸ¥ï¼šå½“å‰æ—¶é—´ Â±30min å†…æ˜¯å¦æœ‰é«˜æ¦‚ç‡æ´»åŠ¨ |
| **SELECT** (MCP) | Patient History MCP | [patient_history_mcp.py](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/mcp_servers/patient_history_mcp.py) | Investigator è·å–è¿åŠ¨é¢„æµ‹ + è¿‘æœŸè¿åŠ¨æ¶ˆè€—æ•°æ® |
| UPDATE/DELETE | âŒ æ—  | â€” | â€” |

> [!IMPORTANT]
> è¯¥è¡¨æ˜¯**ç”¨æˆ·è¿åŠ¨è¡Œä¸ºçš„ç»Ÿè®¡èšåˆè¡¨**ï¼Œåœ¨çœŸå®åœºæ™¯ä¸­åº”ç”±ä¸€ä¸ªç¦»çº¿ç»Ÿè®¡ä»»åŠ¡ï¼ˆå¦‚æ¯å‘¨ cron jobï¼‰æ ¹æ®å†å²é¥æµ‹æ•°æ®è®¡ç®—å¡«å……ã€‚å½“å‰ç³»ç»Ÿæœªå®ç°æ­¤åŠŸèƒ½ï¼Œæµ‹è¯•æ—¶éœ€**æ‰‹åŠ¨æ’å…¥**ã€‚

---

### 4. `user_known_places` â€” ğŸ”´ éœ€å¤–éƒ¨æ’å…¥

| æ“ä½œ | æ¥æº | ä½ç½® | è¯´æ˜ |
|------|------|------|------|
| **INSERT** | âŒ æ— é“¾è·¯å†™å…¥ | â€” | ç³»ç»Ÿä¸ä¼šè‡ªåŠ¨å­¦ä¹ åœ°ç‚¹ï¼Œ**å¿…é¡»æ‰‹åŠ¨/å¤–éƒ¨æ’å…¥** |
| **SELECT** | Location Context MCP | [location_context_mcp.py](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/mcp_servers/location_context_mcp.py) | æŸ¥ç”¨æˆ·æ‰€æœ‰å·²çŸ¥åœ°ç‚¹ï¼Œç”¨ Haversine ç®—è·ç¦» |
| UPDATE/DELETE | âŒ æ—  | â€” | â€” |

> [!NOTE]
> è¯¥è¡¨ä»£è¡¨ç”¨æˆ·è‡ªå®šä¹‰çš„å¸¸å»åœ°ç‚¹ï¼ˆå®¶ã€å¥èº«æˆ¿ã€å…¬å¸ç­‰ï¼‰ï¼Œåœ¨çœŸå®åœºæ™¯ä¸­åº”ç”± App ç«¯è®©ç”¨æˆ·æ ‡æ³¨æˆ–è‡ªåŠ¨èšç±» GPS è½¨è¿¹ã€‚

---

### 5. `intervention_log` â€” âœ… ç³»ç»Ÿè‡ªåŠ¨å†™å…¥

| æ“ä½œ | æ¥æº | ä½ç½® | è¯´æ˜ |
|------|------|------|------|
| **INSERT** | Celery Worker (Communicator) | [communicator.py#_log_intervention](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/agent/nodes/communicator.py) | Agent å‘é€æ¨é€åè®°å½•å¹²é¢„æ—¥å¿— |
| SELECT | âŒ æ—  | â€” | å½“å‰ç³»ç»Ÿä¸è¯»å–å¹²é¢„å†å²ï¼ˆå¯ç”¨äºåç»­åˆ†æï¼‰ |
| UPDATE/DELETE | âŒ æ—  | â€” | â€” |

å†™å…¥å†…å®¹åŒ…æ‹¬ï¼š`trigger_type`, `agent_decision`ï¼ˆReflector çš„ JSON æ¨ç†ç»“æœï¼‰, `message_sent`ï¼ˆå‘ç»™ç”¨æˆ·çš„æ¶ˆæ¯ï¼‰ã€‚

---

### 6. `error_log` â€” âš ï¸ ç³»ç»Ÿè®¾è®¡æœ‰ä½†æœªå®ç°å†™å…¥

| æ“ä½œ | æ¥æº | ä½ç½® | è¯´æ˜ |
|------|------|------|------|
| **INSERT** | âŒ æœªå®ç° | â€” | spec ä¸­è§„å®šå¤–éƒ¨è°ƒç”¨å¤±è´¥æ—¶å†™å…¥ï¼Œä½†å½“å‰ä»£ç ç”¨ structlog è®°æ—¥å¿—ï¼Œæœªå†™è¡¨ |
| SELECT | âŒ æ—  | â€” | â€” |

> [!WARNING]
> å½“å‰æ‰€æœ‰é”™è¯¯å¤„ç†éƒ½åªé€šè¿‡ `structlog` è¾“å‡ºåˆ°ç»ˆç«¯/æ—¥å¿—æ–‡ä»¶ï¼Œæ²¡æœ‰å†™å…¥ `error_log` è¡¨ã€‚å¦‚éœ€åç»­åšé”™è¯¯ç›‘æ§é¢æ¿ï¼Œéœ€è¦åœ¨å„æœåŠ¡çš„ `except` å—ä¸­åŠ å…¥ INSERTã€‚

---

### 7. å†…å­˜æ»‘åŠ¨çª—å£ (`collections.deque`) â€” âœ… ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤

| æ“ä½œ | æ¥æº | ä½ç½® | è¯´æ˜ |
|------|------|------|------|
| **APPEND** | Gateway | [triage.py#evaluate_soft_triggers](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/gateway/services/triage.py) | æ¯æ¬¡è¯·æ±‚è¿½åŠ  [(timestamp, glucose, heart_rate)](file:///Users/juliawang/Desktop/%E6%85%A2%E6%80%A7%E7%97%85AIChallenge/diabetes-guardian/db/models.py#33-37) |
| **READ** | Gateway | åŒä¸Š | å¯¹çª—å£å†…æ•°æ®åš `numpy.polyfit` çº¿æ€§å›å½’ç®—æ–œç‡ |
| **è‡ªåŠ¨æ·˜æ±°** | Python deque | `maxlen=20` | è¶…è¿‡ 20 æ¡è‡ªåŠ¨ä¸¢å¼ƒæœ€æ—§çš„ |

```
ç»“æ„: dict[user_id] â†’ deque(maxlen=20)
æ¯æ¡: (timestamp: datetime, glucose: float, heart_rate: int)
```

**ç‰¹æ€§**ï¼š
- è¿›ç¨‹å†…å­˜ï¼ŒGateway **é‡å¯å³æ¸…ç©º**
- æŒ‰ `user_id` éš”ç¦»ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„çª—å£
- éœ€â‰¥3 æ¡æ•°æ®æ‰èƒ½è®¡ç®—æ–œç‡

---

## æ•°æ®æµå‘æ±‡æ€»å›¾

```
å¤–éƒ¨æ’å…¥ â”€â”€â†’ users
å¤–éƒ¨æ’å…¥ â”€â”€â†’ user_weekly_patterns
å¤–éƒ¨æ’å…¥ â”€â”€â†’ user_known_places

POST /telemetry â”€â”€â†’ user_telemetry_log (Gateway è‡ªåŠ¨å†™)
POST /telemetry â”€â”€â†’ å†…å­˜ deque (Gateway è‡ªåŠ¨ç»´æŠ¤)

Agent Communicator â”€â”€â†’ intervention_log (Celery è‡ªåŠ¨å†™)

(æœªå®ç°) â”€â”€â†’ error_log
```
