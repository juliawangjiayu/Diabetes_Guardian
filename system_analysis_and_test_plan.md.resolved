# ç³»ç»Ÿè¿è¡Œåˆ†æ & æµ‹è¯•æ–¹æ¡ˆ

## 1. ç³»ç»Ÿæ•´ä½“æ•°æ®æµ

```mermaid
sequenceDiagram
    participant App as ğŸ“± ç”¨æˆ·App
    participant GW as Gateway :8000
    participant DB as MySQL
    participant Redis as Redis
    participant Celery as Celery Worker
    participant MCP1 as Patient History MCP :8001
    participant MCP2 as Location Context MCP :8002
    participant LLM as Gemini 2.0 Pro

    App->>GW: POST /telemetry (JSON)
    
    Note over GW: 1. æŸ¥ç”¨æˆ·å¹´é¾„
    GW->>DB: SELECT birth_year FROM users
    DB-->>GW: birth_year=1990 â†’ age=36

    Note over GW: 2. å¹¶å‘ï¼šå†™åº“ + åˆ¤æ–­è§¦å‘
    par å†™å…¥é¥æµ‹æ•°æ®
        GW->>DB: INSERT INTO user_telemetry_log
    and åˆ¤æ–­ç¡¬è§¦å‘
        GW->>DB: SELECT count æœ€è¿‘30åˆ†é’Ÿè®°å½•
        Note over GW: æ£€æŸ¥ä¸‰ä¸ªç¡¬æ¡ä»¶
    end

    alt ç¡¬è§¦å‘å‘½ä¸­
        GW->>App: ğŸš¨ ç´§æ€¥æ¨é€é€šçŸ¥
        GW-->>App: {"status":"received","trigger":"hard"}
    else ç¡¬è§¦å‘æœªå‘½ä¸­ â†’ è¯„ä¼°è½¯è§¦å‘
        Note over GW: ç»´æŠ¤æ»‘åŠ¨çª—å£(deque)<br/>æ£€æŸ¥è¡€ç³–æ–œç‡ + è¿åŠ¨é¢„å¤‡
        GW->>DB: SELECT FROM user_weekly_patterns
        
        alt è½¯è§¦å‘å‘½ä¸­
            GW->>Redis: Celery send_task
            Redis->>Celery: å–å‡ºä»»åŠ¡
            
            par Celeryè°ƒç”¨ä¸¤ä¸ªMCP
                Celery->>MCP1: POST /tools/get_patient_context
                MCP1->>DB: æŸ¥24hè¡€ç³–å†å² + å‘¨æ¨¡å¼ + è¿åŠ¨æ¶ˆè€—
                MCP1-->>Celery: glucose_history + upcoming_activity
            and
                Celery->>MCP2: POST /tools/get_semantic_location
                MCP2->>DB: æŸ¥ user_known_places + Haversineè·ç¦»
                MCP2-->>Celery: semantic_location
            end
            
            Celery->>LLM: Reflector: ä¸´åºŠé£é™©è¯„ä¼°
            LLM-->>Celery: {risk_level, intervention_action}
            
            alt intervention_action â‰  NO_ACTION
                Celery->>LLM: Communicator: ç”Ÿæˆæ¨é€æ–‡æ¡ˆ
                LLM-->>Celery: ä¸ªæ€§åŒ–æ¶ˆæ¯
                Celery->>App: ğŸ“¨ æ¨é€é€šçŸ¥
                Celery->>DB: INSERT INTO intervention_log
            end
            
            GW-->>App: {"status":"received","trigger":"soft"}
        else è½¯è§¦å‘æœªå‘½ä¸­
            GW-->>App: {"status":"received"}
        end
    end
```

## 2. å„æœåŠ¡çš„æ•°æ®ä¾èµ–å…³ç³»

### Gateway API (:8000)

| æ“ä½œ | æ•°æ®æ¥æº | è¯´æ˜ |
|------|----------|------|
| è·å–ç”¨æˆ·å¹´é¾„ | `users` è¡¨ | æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥ï¼Œç”¨äºå¿ƒç‡é˜ˆå€¼è®¡ç®— |
| å†™å…¥é¥æµ‹è®°å½• | `user_telemetry_log` è¡¨ | æ¯æ¬¡è¯·æ±‚éƒ½å†™ |
| ç¡¬è§¦å‘ï¼šæ•°æ®ä¸­æ–­æ£€æŸ¥ | `user_telemetry_log` è¡¨ | æŸ¥æœ€è¿‘30åˆ†é’Ÿæœ‰å¤šå°‘æ¡è®°å½• |
| è½¯è§¦å‘ï¼šè¡€ç³–æ–œç‡ | **å†…å­˜** (`deque` æ»‘åŠ¨çª—å£) | ä¸æŸ¥æ•°æ®åº“ï¼Œç”¨å†…å­˜ä¸­æœ€è¿‘20æ¡åšå›å½’ |
| è½¯è§¦å‘ï¼šè¿åŠ¨é¢„å¤‡ | `user_weekly_patterns` è¡¨ | æŸ¥å½“å‰æ—¶é—´é™„è¿‘Â±30åˆ†é’Ÿçš„æ´»åŠ¨é¢„æµ‹ |

> [!IMPORTANT]
> **è¡€ç³–æ–œç‡è§¦å‘**ä¾èµ–çš„æ˜¯ Gateway è¿›ç¨‹å†…å­˜ä¸­çš„æ»‘åŠ¨çª—å£ï¼Œ**ä¸æ˜¯æ•°æ®åº“**ã€‚è¿™æ„å‘³ç€ï¼š
> - Gateway é‡å¯åï¼Œæ»‘åŠ¨çª—å£æ¸…ç©ºï¼Œéœ€è¦é‡æ–°ç§¯ç´¯æ•°æ®
> - å¿…é¡»å‘é€ **è‡³å°‘3æ¡è¿ç»­é¥æµ‹**æ‰èƒ½è®¡ç®—æ–œç‡
> - æ—¶é—´é—´éš”è¦åœ¨ 20 åˆ†é’Ÿå†…

### Patient History MCP (:8001)

| æ“ä½œ | æ•°æ®æ¥æº | è¯´æ˜ |
|------|----------|------|
| 24h è¡€ç³–å†å² | `user_telemetry_log` è¡¨ | SELECT è¿‡å»24å°æ—¶çš„glucoseè®°å½• |
| è¿åŠ¨é¢„æµ‹ | `user_weekly_patterns` è¡¨ | æŸ¥å½“å‰æ—¶é—´å‘å2å°æ—¶å†…çš„æ´»åŠ¨æ¦‚ç‡ |
| è¿‘æœŸè¿åŠ¨æ¶ˆè€— | `user_weekly_patterns` è¡¨ | å–æœ€è¿‘5æ¡ avg_glucose_drop |

### Location Context MCP (:8002)

| æ“ä½œ | æ•°æ®æ¥æº | è¯´æ˜ |
|------|----------|------|
| è¯­ä¹‰ä½ç½®è§£æ | `user_known_places` è¡¨ | æŸ¥æ‰€æœ‰å·²çŸ¥åœ°ç‚¹ï¼ŒHaversine ç®—è·ç¦» |

---

## 3. ä¸‰ç§åœºæ™¯çš„æµ‹è¯•æ–¹æ¡ˆ

### å‰ç½®æ¡ä»¶ï¼ˆæ•°æ®åº“ä¸­éœ€è¦çš„æ•°æ®ï¼‰

å·²æ’å…¥çš„æµ‹è¯•æ•°æ®ï¼š

```sql
-- âœ… å·²æœ‰
users:              user_001, birth_year=1990
weekly_patterns:    user_001, day_of_week=0(å‘¨ä¸€), hour=17, resistance_training, p=0.85
known_places:       user_001, å®¶(39.9042, 116.4074), è¶…çº§å¥èº«æˆ¿(39.91, 116.41)
```

---

### åœºæ™¯ Bï¼šç¡¬è§¦å‘ âŒğŸš¨

**è§¦å‘æ¡ä»¶**ï¼š`glucose < 3.9 mmol/L`

```bash
curl -X POST http://127.0.0.1:8000/telemetry \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_001",
    "timestamp": "2026-02-23T16:50:00",
    "heart_rate": 75,
    "glucose": 3.1,
    "gps_lat": 39.9042,
    "gps_lng": 116.4074
  }'
```

**é¢„æœŸç»“æœ**ï¼š
- è¿”å› `{"status":"received","trigger":"hard"}`
- Gateway æ—¥å¿—æ˜¾ç¤º `hard_trigger_fired` + `emergency_alert_sent`
- **ä¸ä¼š**è§¦å‘ Celery ä»»åŠ¡
- æ•°æ®å†™å…¥ `user_telemetry_log`

---

### åœºæ™¯ Aï¼šè½¯è§¦å‘ âš ï¸

**è§¦å‘æ¡ä»¶**ï¼šglucose åœ¨ [4.0, 5.6] ä¸”å½“å‰æ—¶é—´é™„è¿‘æœ‰é«˜æ¦‚ç‡æ´»åŠ¨

> [!WARNING]  
> **æ—¶é—´æ•æ„Ÿ**ï¼šè½¯è§¦å‘çš„"è¿åŠ¨é¢„å¤‡"æ¡ä»¶éœ€è¦å½“å‰è¯·æ±‚çš„æ—¶é—´ä¸ `user_weekly_patterns` ä¸­çš„ `hour_of_day` åŒ¹é…ã€‚æˆ‘ä»¬æ’å…¥çš„æ˜¯ `hour=17`ï¼ˆä¸‹åˆ5ç‚¹ï¼‰ï¼Œæ‰€ä»¥ timestamp éœ€è¦è®¾åœ¨ **16:30~17:30 ä¹‹é—´**æ‰èƒ½å‘½ä¸­ã€‚

```bash
curl -X POST http://127.0.0.1:8000/telemetry \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_001",
    "timestamp": "2026-02-23T16:50:00",
    "heart_rate": 75,
    "glucose": 4.8,
    "gps_lat": 39.9042,
    "gps_lng": 116.4074
  }'
```

**é¢„æœŸç»“æœ**ï¼š
- è¿”å› `{"status":"received","trigger":"soft"}`
- Gateway æ—¥å¿—æ˜¾ç¤º `soft_trigger_fired` (type=`SOFT_PRE_EXERCISE_LOW_BUFFER`)
- Celery Worker æ”¶åˆ°ä»»åŠ¡ï¼Œæ—¥å¿—æ˜¾ç¤º `agent_graph_starting`
- Investigator è°ƒç”¨ä¸¤ä¸ª MCP Server
- Reflector è°ƒç”¨ Gemini API åšé£é™©è¯„ä¼°
- Communicator ç”Ÿæˆæ¨é€æ¶ˆæ¯å¹¶å†™å…¥ `intervention_log`

---

### åœºæ™¯ Cï¼šæ— è§¦å‘ âœ…

**æ¡ä»¶**ï¼šglucose å®‰å…¨ï¼Œå¿ƒç‡æ­£å¸¸ï¼Œæ— è¿‘æœŸè¿åŠ¨è®¡åˆ’

> [!NOTE]  
> ä¸ºäº†ç¡®ä¿ä¸å‘½ä¸­è¿åŠ¨é¢„å¤‡æ¡ä»¶ï¼Œtimestamp è®¾åœ¨è¿œç¦»17ç‚¹çš„æ—¶é—´ï¼ˆå¦‚ä¸Šåˆ10ç‚¹ï¼‰

```bash
curl -X POST http://127.0.0.1:8000/telemetry \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_001",
    "timestamp": "2026-02-23T10:00:00",
    "heart_rate": 80,
    "glucose": 6.2,
    "gps_lat": 39.9042,
    "gps_lng": 116.4074
  }'
```

**é¢„æœŸç»“æœ**ï¼š
- è¿”å› `{"status":"received"}` ï¼ˆæ—  trigger å­—æ®µï¼‰
- æ—  emergency alertï¼Œæ—  Celery ä»»åŠ¡
- æ•°æ®ä»ä¼šå†™å…¥ `user_telemetry_log`

---

## 4. æµ‹è¯•æ‰§è¡Œé¡ºåºå»ºè®®

| é¡ºåº | åœºæ™¯ | åŸå›  |
|------|------|------|
| 1 | åœºæ™¯ C (æ— è§¦å‘) | æœ€ç®€å•ï¼Œå…ˆéªŒè¯åŸºæœ¬é“¾è·¯é€šç•… |
| 2 | åœºæ™¯ B (ç¡¬è§¦å‘) | åªèµ° Gateway å±‚ï¼Œä¸éœ€è¦ Celery/MCP |
| 3 | åœºæ™¯ A (è½¯è§¦å‘) | å…¨é“¾è·¯æµ‹è¯•ï¼Œä¾èµ–æ‰€æœ‰æœåŠ¡ |

> [!TIP]
> æµ‹è¯•æ—¶å»ºè®®è§‚å¯Ÿ Gateway å’Œ Celery Worker çš„ç»ˆç«¯æ—¥å¿—è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°å®Œæ•´çš„å¤„ç†è¿‡ç¨‹ã€‚
